stages:
    - compile
    - test
    - quality

variables:
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_STRATEGY: fetch


.ciconf:
    only:
        variables:
            - $CI_PROJECT_NAMESPACE == "keszocze"

try_compiling:
    extends: .ciconf
    stage: compile
    artifacts:
        paths:
            - build
        expire_in: 30 minutes

    script:
        - mkdir -p build/bw_output
        - cd build
        - CC=gcc-8 CXX=g++-8 cmake ..
        - /opt/sonar-build-wrapper/build-wrapper-linux-x86-64 --out-dir bw_output make -j 4 all


run_sonarqube:
    extends: .ciconf
    stage: quality
    script: 
        - /opt/sonar-scanner/bin/sonar-scanner

run_tests:
    extends: .ciconf
    stage: test
    artifacts:
        paths:
            - build/tests/coverage
        expire_in: 30 minutes
    script:
        - cd build/tests
        - find -name "*-test" -exec {} \;
        - rm -rf coverage
        - mkdir -p coverage
        - /opt/software/usr/local/bin/gcovr --gcov-executable gcov-8 -v -r ../../ --object-directory CMakeFiles --sonarqube coverage/coverage.xml 
